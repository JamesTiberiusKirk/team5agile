<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Store Locator</title>
    <meta name='robots' content='noindex, nofollow'>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
      type="text/css"
    />

    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/geojson/0.5.0/geojson.min.js"></script>
  </head>
  <body> 
   <div class='sidebar'>
    <!-- The overlay -->
    <div id="myNav" class="overlay">

      <!-- Overlay content -->
      <div class="overlay-content">
        <div class='heading'>
          <h1>
              <!-- Button to close the overlay navigation -->
              <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&larr; Edit Search </a>
          </h1>
        </div>
        <div id='listings' class='listings'></div>
      </div>

    </div>
  
       
       <div class="py-4" style="">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <form id="c_form-h" class="" style="">
                <div class="form-group row"> <label for="inputmailh" class="col-2 col-form-label">Treatment</label>
                  <div class="col-10">
                    <div class="form-group row">
                      <div class="col-10"><input type="text" class="form-control" id="inputnameid" placeholder="Treatment name / Treatment ID"></div>
                    </div>
                  </div>
                </div>
                <div class="form-group row"><label for="inputpasswordh" class="col-2 col-form-label" contenteditable="true">Street Address</label>
                  <div class="col-10">
                    <div class="form-group row">
                      <div class="col-10"><input type="text" class="form-control" id="inputstreet"></div>
                    </div>
                  </div>
                </div>
                <div class="form-group row"><label for="inputmailh" class="col-2 col-form-label">Zip Code</label>
                  <div class="col-10">
                    <div class="form-group row">
                      <div class="col-10"><input type="text" class="form-control" id="inputzipcode"></div>
                    </div>
                  </div>
                </div>
                <div class="form-group row"><label for="inputmailh" class="col-2 col-form-label">City</label>
                  <div class="col-10">
                    <div class="form-group row">
                      <div class="col-10"><input type="text" class="form-control" id="inputcity"></div>
                    </div>
                  </div>
                </div>
                <div class="form-group row"><label for="inputmailh" class="col-2 col-form-label">State</label>
                  <div class="col-10">
                    <div class="form-group row">
                      <div class="col-10">
                        <select>
                          <option value="select-state">Select state</option>
                          <option value="AL">AL</option>
                          <option value="AK">AK</option>
                          <option value="AR">AR</option>
                          <option value="AZ">AZ</option>
                          <option value="CA">CA</option>
                          <option value="CO">CO</option>
                          <option value="CT">CT</option>
                          <option value="DC">DC</option>
                          <option value="DE">DE</option>
                          <option value="FL">FL</option>
                          <option value="GA">GA</option>
                          <option value="HI">HI</option>
                          <option value="IA">IA</option>
                          <option value="ID">ID</option>
                          <option value="IL">IL</option>
                          <option value="IN">IN</option>
                          <option value="KS">KS</option>
                          <option value="KY">KY</option>
                          <option value="LA">LA</option>
                          <option value="MA">MA</option>
                          <option value="MD">MD</option>
                          <option value="ME">ME</option>
                          <option value="MI">MI</option>
                          <option value="MN">MN</option>
                          <option value="MO">MO</option>
                          <option value="MS">MS</option>
                          <option value="MT">MT</option>
                          <option value="NC">NC</option>
                          <option value="NE">NE</option>
                          <option value="NH">NH</option>
                          <option value="NJ">NJ</option>
                          <option value="NM">NM</option>
                          <option value="NV">NV</option>
                          <option value="NY">NY</option>
                          <option value="ND">ND</option>
                          <option value="OH">OH</option>
                          <option value="OK">OK</option>
                          <option value="OR">OR</option>
                          <option value="PA">PA</option>
                          <option value="RI">RI</option>
                          <option value="SC">SC</option>
                          <option value="SD">SD</option>
                          <option value="TN">TN</option>
                          <option value="TX">TX</option>
                          <option value="UT">UT</option>
                          <option value="VT">VT</option>
                          <option value="VA">VA</option>
                          <option value="WA">WA</option>
                          <option value="WI">WI</option>
                          <option value="WV">WV</option>
                          <option value="WY">WY</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Use any element to open/show the overlay navigation menu -->
                <span onclick="openNav()"><button class="submit-button" onclick="getProcedures()"><a class="btn navbar-btn btn-outline-primary pl-4 pr-4" href="#register">Submit</a></button></span>
              </form>

              <h5>Search for Procedure: <input type="text" id="place" value=""> <button id="submitButton"
                class="btn navbar-btn mx-2 btn-outline-success" onclick="getProcedures();">Submit</button>

              <script>
                var input = document.getElementById("place");
                input.addEventListener("keyup", function (event) {
                  if (event.keyCode === 13) {
                    event.preventDefault();
                    document.getElementById("submitButton").click();
                  }
                });
              </script>
    
              
              <div id="container"></div>
              <script>
                // function displaySort() {
                //   if(document.getElementById("sort").style.display = "none") {
                //     document.getElementById("sort").style.display = "inline";
                //   } else {
                //     document.getElementById("sort").style.display = "none";
                //   }
                // }

    
                function insert(prov) {
    
                  var div = document.getElementById('container');
                  var child_div = document.createElement('div');
                  var pro_name = prov.procedure_Def;
                  var prov_name = prov.provider_Name;
                  var pro_price = prov.avg_Medicare_Payments;
                  child_div.innerHTML = `<p>${prov_name}: ${pro_name}: $${pro_price} </p>`;
                  div.appendChild(child_div)
    
                }
    
                function getProcedures() {
                  var url = `https://api.team5agile.dumitruvulpe.com`;
                  var pro_uri = `/procedures/?search_query=`;
                  var procedureName = document.getElementById("place").value;
    
                  fetch(url + pro_uri + procedureName)
                    .then((res) => {
                      return res.json();
                    })
                    .then((data) => {
                      //console.log(data)
                      data.forEach(e => {
                        insert(e)
                        
                        searchForProviderZip(e.provider_Zip)
                          .then((res) => {
                            //do smth with res
                            //console.log('resolve')
                            createGeoJSON(data, e, res)
                          }).catch((err) => {
                            console.log('reject')
                            console.log(err)
                            //deal with err
                          });
                      });
                    })
                    .catch((error) => {
                      console.log(error)
                    });
    
                }
    
                function searchForProviderZip(zip_code) {
                  return new Promise((resolve, reject) => {
                    var url = `https://api.team5agile.dumitruvulpe.com`;
                    var zip_uri = '/zip2coords?zip=';
                    fetch(url + zip_uri + zip_code)
                      .then((res) => {
                        return res.json();
                      })
                      .then((data) => {                  
                        resolve(data);
                      })
                      .catch((err) => {
                        reject(err);
                      });
                  });
    
    
    
                }

                var newdata;
                var dataGeoJSON;
                var id = `id`;
                var i = 0;

                const createGeoJSON = (data, e, res) => {
                      //  console.log("data")
                      //  console.log(data) //all procedures in array
                      //  console.log("e")
                      //  console.log(e) //each individual procedure
                      //  console.log("res")
                      //  console.log(res) //each individual zip code coords
                      //  console.log("data[0]")
                      //  console.log(data[0]) //first provider in array
                      
                        newdata = [
                              {
                                  lat: res[0].zip_Lat,
                                  lng: res[0].zip_Long
                              }
                          ];
    
                          newdata[0]["procedure_ID"] = e.procedure_ID;
                          newdata[0]["procedure_Def"] = e.procedure_Def;
                          newdata[0]["provider_Name"] = e.provider_Name;
                          newdata[0]["provider_StreetAdd"] = e.provider_StreetAdd;
                          newdata[0]["provider_City"] = e.provider_City;
                          newdata[0]["provider_State"] =  e.provider_State;
                          newdata[0]["provider_Zip"] = e.provider_Zip;
                          newdata[0]["avg_Covered_Charges"] = e.avg_Covered_Charges;
                          newdata[0]["avg_Total_Payments"] = e.avg_Total_Payments;
                          newdata[0]["avg_Medicare_Payments"] = e.avg_Medicare_Payments;
                          newdata[0]["provider_referral"] = e.provider_referral;
                          newdata[0][id] = i++;
    
                        dataGeoJSON = GeoJSON.parse(newdata, { Point: ["lat", "lng"] });
                        output = JSON.stringify(dataGeoJSON, null, 4);
                        // console.log(output)
                        console.log(dataGeoJSON)
    
                   }
    
              /**
              * Assign a unique id to each provider. You'll use this `id`
              * later to associate each point on the map with a listing
              * in the sidebar. DONE ABOVE WHEN ASSIGNING DATA
              */                
                // dataGeoJSON.features.forEach(function (dataGeoJSON, i) {
                //   dataGeoJSON.properties.id = i;
                // });


              </script>
            
            </div>
          </div>
        </div>
      </div> 
    </div>
    <div id='map' class='map'></div>
    <div id="geocoder" class="geocoder"></div>
    <script src="mapscript.js"></script>
    
  </body>
</html>